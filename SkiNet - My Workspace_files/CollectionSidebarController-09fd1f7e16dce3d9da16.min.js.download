(window.webpackJsonp=window.webpackJsonp||[]).push([[86],{"./runtime-repl/collection/sidebar/CollectionSidebarController.js":function(e,t,o){"use strict";o.r(t),function(e){o.d(t,"default",(function(){return w}));var i,s,r=o("../../node_modules/mobx/lib/mobx.module.js"),l=o("./js/stores/get-store.js"),a=o("./js/modules/controllers/PermissionController.js"),n=o("./runtime-repl/extensible-collection/api/ExtensibleCollectionAPI.ts"),d=o.n(n),c=o("./runtime-repl/collection/sidebar/CollectionSidebarModel.js"),u=o("./runtime-repl/collection/datastores/adapters/CollectionModelEventsAdapter.js"),p=o("./runtime-repl/folder/datastores/adapters/FolderModelEventsAdapter.js"),m=o("./runtime-repl/request-http/datastores/adapters/RequestModelEventsAdapter.js"),h=o("./runtime-repl/example/datastores/adapters/ResponseModelEventsAdapter.js"),b=o("./runtime-repl/collection/datastores/adapters/CollectionListingAPIAdapter.js"),g=o("./runtime-repl/_common/WorkbenchStatusConstants.js"),S=o("./onboarding/src/common/dependencies.js"),C=o("./runtime-repl/_common/SyncEndpoints.js"),y=o("./runtime-repl/collection/_api/CollectionStoreV2.js");function f(e,t,o,i,s){var r={};return Object.keys(i).forEach((function(e){r[e]=i[e]})),r.enumerable=!!r.enumerable,r.configurable=!!r.configurable,("value"in r||r.initializer)&&(r.writable=!0),r=o.slice().reverse().reduce((function(o,i){return i(e,t,o)||o}),r),s&&void 0!==r.initializer&&(r.value=r.initializer?r.initializer.call(s):void 0,r.initializer=void 0),void 0===r.initializer&&(Object.defineProperty(e,t,r),r=null),r}let w=(s=f((i=class{constructor(){var e,t,o,i;this.model=null,this._adapters=[],e=this,t="status",i=this,(o=s)&&Object.defineProperty(e,t,{enumerable:o.enumerable,configurable:o.configurable,writable:o.writable,value:o.initializer?o.initializer.call(i):void 0})}async didCreate(){this.model=new c.default;try{await this._loadFromListingAPI(),await this._loadExtensibleCollections(),this.setSidebarStatus(g.READY)}catch(e){pm.logger.error("CollectionSidebarController~didCreate: Failed to fetch collection list:",e)}this.model.collectionList=await y.default.subscribe();const e=e=>e&&Object(l.getStore)("CollectionStore").find(Object(S.decomposeUID)(e).modelId);try{await Object(r.when)(()=>this.model.collectionList.ids.every(e),{timeout:6e4})}catch(e){pm.logger.warn("CollectionSidebarController~didCreate: Timed out while waiting for store to be fully hydrated",e)}try{await this._loadFromModelEventsAdapter()}catch(e){return pm.logger.error("CollectionSidebarController~didCreate: Error in loading collections from model events",e),this.status===g.LOADING&&this.setSidebarStatus(g.ERROR)}return this.setSidebarStatus(g.READY)}beforeDestroy(){this._adapters&&this._adapters.forEach(t=>{e.isFunction(t.dispose)&&t.dispose()}),this.extensibleCollectionChangeListenersDisposer&&this.extensibleCollectionChangeListenersDisposer(),this.model=null,this._adapters=[]}setSidebarStatus(e){this.status=e}async _fetchCollections(){await Object(l.getStore)("SyncStatusStore").onSyncAvailable();const t=Object(l.getStore)("ActiveWorkspaceStore").id,o=await S.RemoteSyncRequestService.request(C.COLLECTION_LIST`${t}`,{method:"POST",timeout:3e4}),i=e.forEach(e.get(o,"body.data",[]),t=>{const o={model:"collection",modelId:t.id,action:"UPDATE_COLLECTION"},i=a.default.getCompositeKey(o);!Object(l.getStore)("PermissionStore").members.has(i)&&e.set(t,"attributes.permissions.userCanUpdate",!0)});return this.model.hydrate&&this.model.hydrate(i),i}async _loadExtensibleCollections(){let e;try{e=await d.a.list()}catch(e){pm.logger.error("CollectionSidebarController~_loadExtensibleCollections",e)}this.model.hydrateExtensibleCollection(e),this.extensibleCollectionChangeListenersDisposer=d.a.cacheAPI.subscribeToChanges(this.model.getExtensibleCollectionEventListeners())}async _loadFromListingAPI(){!function(t){if(e.isEmpty(t))return;const o=[],i=[],s=[],r=[];t.forEach(t=>{const l=e.get(t,"attributes.flags.isFavorite"),a=e.get(t,"attributes.permissions.teamCanView"),n=e.get(t,"attributes.permissions.anybodyCanView"),d=e.get(t,"attributes.flags.isArchived"),c=Object(S.decomposeUID)(t.id).modelId,u={id:c};l&&o.push(u),a&&i.push(u),n&&s.push({id:t.id}),d&&r.push({model:"collection",modelId:c})}),!e.isEmpty(o)&&Object(l.getStore)("FavoritedCollectionStore").add(o),!e.isEmpty(i)&&Object(l.getStore)("SharedCollectionsStore").add(i),!e.isEmpty(s)&&Object(l.getStore)("PublicEntityStore").add(s),!e.isEmpty(r)&&Object(l.getStore)("ArchivedResourceStore").add(r)}(await this._fetchCollections())}async _loadFromModelEventsAdapter(){const e=Object(l.getStore)("ActiveWorkspaceStore").id,t=new u.default(this.model.getCollectionAdapterModel(),{activeWorkspace:e,useUID:!0}),o=new p.default(this.model.getFolderAdapterModel()),i=new m.default(this.model.getRequestAdapterModel()),s=[t.hydrate(),o.hydrate(),i.hydrate()];this._adapters.push(t,o,i),await Promise.all(s),this.setSidebarStatus(g.READY);const r=new h.default(this.model.getResponseAdapterModel());this._adapters.push(r),await r.hydrate()}async _loadFromListingAPIAdapter(){const e=new b.default(this.model.getCollectionAdapterModel());this._adapters.push(e),await e.hydrate()}}).prototype,"status",[r.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return g.LOADING}}),f(i.prototype,"setSidebarStatus",[r.action],Object.getOwnPropertyDescriptor(i.prototype,"setSidebarStatus"),i.prototype),i)}.call(this,o("./node_modules/lodash/lodash.js"))}}]);
//# sourceMappingURL=CollectionSidebarController-09fd1f7e16dce3d9da16.min.js.map